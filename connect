#!/bin/bash

# File to store connection history
CONFIG_FILE="$HOME/.ssh_connections"

# --- Colors for UI ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# --- Helper Functions ---

# Function to display a banner
show_banner() {
  echo -e "${BLUE}
   _   _ _____ _____ ____  __  __ ___ _   _ 
  | \ | | ____| ____|  _ \|  \/  |_ _| \ | |
  |  \| |  _| |  _| | |_) | |\/| || ||  \| |
  | |\  | |___| |___|  _ <| |  | || || |\  |
  |_| \_|_____|_____|_| \_\_|  |_|___|_| \_|
  ${NC}"
  echo -e "${YELLOW}           v1.0 - by https://github.com/iiTz4i4a${NC}"
  echo
}

# Function to add a new connection to the history file
add_connection() {
  local alias=$1
  local user=$2
  local host=$3
  local password=$4
  local port=${5:-22} # Default to port 22 if not provided
  local key_path=$6
  echo "$alias|$user|$host|$password|$port|$key_path" >>"$CONFIG_FILE"
}

# Function to establish the SSH connection
connect_to_host() {
  local user=$1
  local host=$2
  local password=$3
  local port=${4:-22}
  local key_path=$5

  if [ -n "$key_path" ]; then
    echo -e "Connecting to ${GREEN}$host${NC} on port ${GREEN}$port${NC} with user ${GREEN}$user${NC} using an SSH key..."
    ssh -o StrictHostKeyChecking=no -p "$port" -i "$key_path" "$user@$host"
  elif [ -n "$password" ]; then
    if ! command -v sshpass &>/dev/null; then
      echo -e "${RED}Error: 'sshpass' is not installed. Please install it to use password-based connections.${NC}"
      exit 1
    fi
    echo -e "Connecting to ${GREEN}$host${NC} on port ${GREEN}$port${NC} with user ${GREEN}$user${NC}..."
    sshpass -p "$password" ssh -o StrictHostKeyChecking=no -p "$port" "$user@$host"
  else
    echo -e "Connecting to ${GREEN}$host${NC} on port ${GREEN}$port${NC} with user ${GREEN}$user${NC} (no password or key saved)..."
    ssh -o StrictHostKeyChecking=no -p "$port" "$user@$host"
  fi
}

# Function to handle removing a connection
remove_connection() {
  if [ ! -s "$CONFIG_FILE" ]; then
    echo -e "${YELLOW}Connection history is empty. Nothing to remove.${NC}"
    return
  fi

  echo -e "${YELLOW}Select a connection to remove:${NC}"
  mapfile -t connections <"$CONFIG_FILE"
  for i in "${!connections[@]}"; do
    alias=$(echo "${connections[$i]}" | cut -d'|' -f1)
    echo "  $((i + 1))) $alias"
  done
  echo "  0) Cancel"

  read -p "Enter number: " choice
  if [[ "$choice" -gt 0 && "$choice" -le "${#connections[@]}" ]]; then
    # Create a temporary file excluding the selected line
    grep -v -F "${connections[$((choice - 1))]}" "$CONFIG_FILE" >"$CONFIG_FILE.tmp"
    mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
    echo -e "${GREEN}Connection removed.${NC}"
  else
    echo "Removal cancelled."
  fi
}

# Function to handle renaming a connection
rename_connection() {
  if [ ! -s "$CONFIG_FILE" ]; then
    echo -e "${YELLOW}Connection history is empty. Nothing to rename.${NC}"
    return
  fi

  echo -e "${YELLOW}Select a connection to rename:${NC}"
  mapfile -t connections <"$CONFIG_FILE"
  for i in "${!connections[@]}"; do
    alias=$(echo "${connections[$i]}" | cut -d'|' -f1)
    echo "  $((i + 1))) $alias"
  done
  echo "  0) Cancel"

  read -p "Enter number: " choice
  if [[ "$choice" -gt 0 && "$choice" -le "${#connections[@]}" ]]; then
    read -p "Enter the new alias: " new_alias
    
    # Escape for sed
    escaped_connection=$(sed 's/[&/\]/\\&/g' <<<"${connections[$((choice - 1))]}")
    
    # Split the line and replace the alias
    IFS='|' read -r old_alias user host password port key_path <<<"${connections[$((choice - 1))]}"
    new_connection_line="$new_alias|$user|$host|$password|$port|$key_path"
    
    # Escape new connection line for sed
    escaped_new_connection=$(sed 's/[&/\]/\\&/g' <<<"$new_connection_line")

    # Use sed to replace the line in the file
    sed -i "s/$escaped_connection/$escaped_new_connection/" "$CONFIG_FILE"
    
    echo -e "${GREEN}Connection renamed.${NC}"
  else
    echo "Rename cancelled."
  fi
}

# Main function for the interactive menu
show_menu() {
  while true; do
    clear
    show_banner
    echo -e "${BOLD}${CYAN}  Select a connection:${NC}"
    if [ -s "$CONFIG_FILE" ]; then
      mapfile -t connections <"$CONFIG_FILE"
      for i in "${!connections[@]}"; do
        alias=$(echo "${connections[$i]}" | cut -d'|' -f1)
        echo -e "  ${YELLOW}$((i + 1)))${NC} $alias"
      done
    else
      echo -e "  ${YELLOW}No saved connections.${NC}"
    fi
    echo
    echo -e "  ${GREEN}a) Add a new connection${NC}"
    echo -e "  ${RED}r) Remove a connection${NC}"
    echo -e "  ${BLUE}e) Rename a connection${NC}"
    echo -e "  ${YELLOW}q) Quit${NC}"
    echo

    read -p "  Enter your choice: " choice

    case $choice in
    [1-9]*)
      if [[ "$choice" -le "${#connections[@]}" ]]; then
        IFS='|' read -r alias user host password port key_path <<<"${connections[$((choice - 1))]}"
        connect_to_host "$user" "$host" "$password" "$port" "$key_path"
        break
      else
        echo -e "${RED}Invalid selection.${NC}"
        sleep 1
      fi
      ;;
    a | A)
      read -p "Enter alias for the connection: " new_alias
      read -p "Enter username: " new_user
      read -p "Enter host (IP or domain): " new_host
      read -p "Enter port (default is 22): " new_port
      echo -e "Authentication method:"
      echo -e "  1) Password"
      echo -e "  2) SSH Key"
      read -p "Select authentication method: " auth_method
      
      new_password=""
      new_key_path=""

      if [ "$auth_method" = "1" ]; then
        read -s -p "Enter password: " new_password
        echo
      elif [ "$auth_method" = "2" ]; then
        read -p "Enter path to the SSH key: " new_key_path
      else
        echo -e "${RED}Invalid selection. Defaulting to no password.${NC}"
      fi

      add_connection "$new_alias" "$new_user" "$new_host" "$new_password" "$new_port" "$new_key_path"
      echo -e "${GREEN}Connection saved!${NC}"
      connect_to_host "$new_user" "$new_host" "$new_password" "$new_port" "$new_key_path"
      break
      ;;
    r | R)
      remove_connection
      read -n 1 -s -r -p "Press any key to return to the menu..."
      ;;
    e | E)
      rename_connection
      read -n 1 -s -r -p "Press any key to return to the menu..."
      ;;
    q | Q)
      exit 0
      ;;
    *)
      echo -e "${RED}Invalid choice. Please try again.${NC}"
      sleep 1
      ;;
    esac
  done
}

# --- Main Script Logic ---

# Create config file if it doesn't exist
touch "$CONFIG_FILE"

# If an argument is provided, use direct connection mode
if [ -n "$1" ]; then
  connection_string=$1
  key_path=""

  # Check for key path argument
  if [ "$2" = "-i" ] && [ -n "$3" ]; then
    key_path=$3
  fi
  
  user_host=$(echo "$connection_string" | cut -d':' -f1)
  port_in_str=$(echo "$connection_string" | cut -d':' -f2)
  user=$(echo "$user_host" | cut -d'@' -f1)
  host=$(echo "$user_host" | cut -d'@' -f2)

  # If port is not provided in the connection string, set it to 22
  if [ "$port_in_str" = "$user_host" ]; then
    port=22
  else
    port=$port_in_str
  fi

  # Check if connection exists in history
  existing_connection=$(grep "|$user|$host|.*|$port" "$CONFIG_FILE")

  if [ -n "$existing_connection" ]; then
    IFS='|' read -r alias user host password port key_path_saved <<<"$(echo "$existing_connection" | head -n 1)"
    # If a key is provided as an argument, use it. Otherwise, use the saved key.
    if [ -z "$key_path" ]; then
      key_path=$key_path_saved
    fi
    connect_to_host "$user" "$host" "$password" "$port" "$key_path"
  else
    echo "This is a new connection."
    read -p "Enter an alias to save this connection: " new_alias
    
    new_password=""
    if [ -z "$key_path" ]; then
      read -s -p "Enter password (leave blank if none): " new_password
      echo
    fi
    
    add_connection "$new_alias" "$user" "$host" "$new_password" "$port" "$key_path"
    echo -e "${GREEN}Connection saved!${NC}"
    connect_to_host "$user" "$host" "$new_password" "$port" "$key_path"
  fi
else
  # Show interactive menu if no arguments
  show_menu
fi
