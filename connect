#!/bin/bash

# File to store connection history
CONFIG_FILE="$HOME/.ssh_connections"

# --- Colors for UI ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# --- Helper Functions ---

# Function to display a banner
show_banner() {
    echo -e "${BLUE}=======================================${NC}"
    echo -e "${BLUE}    SSH Connection Manager v1.0      ${NC}"
    echo -e "${BLUE}=======================================${NC}"
    echo
}

# Function to add a new connection to the history file
add_connection() {
    local alias=$1
    local user=$2
    local host=$3
    local password=$4
    echo "$alias|$user|$host|$password" >> "$CONFIG_FILE"
}

# Function to establish the SSH connection
connect_to_host() {
    local user=$1
    local host=$2
    local password=$3

    if [ -n "$password" ]; then
        if ! command -v sshpass &> /dev/null; then
            echo -e "${RED}Error: 'sshpass' is not installed. Please install it to use password-based connections.${NC}"
            exit 1
        fi
        echo -e "Connecting to ${GREEN}$host${NC} with user ${GREEN}$user${NC}..."
        sshpass -p "$password" ssh -o StrictHostKeyChecking=no "$user@$host"
    else
        echo -e "Connecting to ${GREEN}$host${NC} with user ${GREEN}$user${NC} (no password saved)..."
        ssh "$user@$host"
    fi
}

# Function to handle removing a connection
remove_connection() {
    if [ ! -s "$CONFIG_FILE" ]; then
        echo -e "${YELLOW}Connection history is empty. Nothing to remove.${NC}"
        return
    fi

    echo -e "${YELLOW}Select a connection to remove:${NC}"
    mapfile -t connections < "$CONFIG_FILE"
    for i in "${!connections[@]}"; do
        alias=$(echo "${connections[$i]}" | cut -d'|' -f1)
        echo "  $((i+1))) $alias"
    done
    echo "  0) Cancel"

    read -p "Enter number: " choice
    if [[ "$choice" -gt 0 && "$choice" -le "${#connections[@]}" ]]; then
        # Create a temporary file excluding the selected line
        grep -v -F "${connections[$((choice-1))]}" "$CONFIG_FILE" > "$CONFIG_FILE.tmp"
        mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
        echo -e "${GREEN}Connection removed.${NC}"
    else
        echo "Removal cancelled."
    fi
}

# Main function for the interactive menu
show_menu() {
    while true; do
        show_banner
        echo "Select a connection:"
        if [ -s "$CONFIG_FILE" ]; then
            mapfile -t connections < "$CONFIG_FILE"
            for i in "${!connections[@]}"; do
                alias=$(echo "${connections[$i]}" | cut -d'|' -f1)
                echo "  $((i+1))) $alias"
            done
        else
            echo -e "${YELLOW}  No saved connections.${NC}"
        fi
        echo
        echo "  a) Add a new connection"
        echo "  r) Remove a connection"
        echo "  q) Quit"
        echo

        read -p "Enter your choice: " choice

        case $choice in
            [1-9]*)
                if [[ "$choice" -le "${#connections[@]}" ]]; then
                    IFS='|' read -r alias user host password <<< "${connections[$((choice-1))]}"
                    connect_to_host "$user" "$host" "$password"
                    break
                else
                    echo -e "${RED}Invalid selection.${NC}"
                fi
                ;;
            a|A)
                read -p "Enter alias for the connection: " new_alias
                read -p "Enter username: " new_user
                read -p "Enter host (IP or domain): " new_host
                read -s -p "Enter password (leave blank if none): " new_password
                echo
                add_connection "$new_alias" "$new_user" "$new_host" "$new_password"
                echo -e "${GREEN}Connection saved!${NC}"
                connect_to_host "$new_user" "$new_host" "$new_password"
                break
                ;;
            r|R)
                remove_connection
                read -n 1 -s -r -p "Press any key to return to the menu..."
                ;;
            q|Q)
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid choice. Please try again.${NC}"
                sleep 1
                ;;
        esac
        clear
    done
}


# --- Main Script Logic ---

# Create config file if it doesn't exist
touch "$CONFIG_FILE"

# If an argument is provided, use direct connection mode
if [ -n "$1" ]; then
    connection_string=$1
    user=$(echo "$connection_string" | cut -d'@' -f1)
    host=$(echo "$connection_string" | cut -d'@' -f2)

    # Check if connection exists in history
    existing_connection=$(grep "|$user|$host|" "$CONFIG_FILE")

    if [ -n "$existing_connection" ]; then
        IFS='|' read -r alias user host password <<< "$existing_connection"
        connect_to_host "$user" "$host" "$password"
    else
        echo "This is a new connection."
        read -p "Enter an alias to save this connection: " new_alias
        read -s -p "Enter password (leave blank if none): " new_password
        echo
        add_connection "$new_alias" "$user" "$host" "$new_password"
        echo -e "${GREEN}Connection saved!${NC}"
        connect_to_host "$user" "$host" "$new_password"
    fi
else
    # Show interactive menu if no arguments
    show_menu
fi
